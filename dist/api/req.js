"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.API=void 0;var _extends=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},_createClass=function(){function a(e,r){for(var t=0;t<r.length;t++){var a=r[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,r,t){return r&&a(e.prototype,r),t&&a(e,t),e}}(),_index=require("../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../spx/index.js"),_index4=_interopRequireDefault(_index3),_index5=require("../npm/qs/lib/index.js"),_index6=_interopRequireDefault(_index5);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function addQuery(e,r){return e+(0<=e.indexOf("?")?"&":"?")+r}var API=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,n);var r=e.baseURL,t=void 0===r?"/":r;/\/$/.test(t)||(t+="/"),e.company_id=1;var a=wx.getExtConfigSync?wx.getExtConfigSync():{};e.appid=a.appid,a.company_id&&(e.company_id=a.company_id),this.options=e,this.baseURL=t,this.genMethods(["get","post","delete","put"])}return _createClass(n,[{key:"genMethods",value:function(e){var n=this;e.forEach(function(a){n[a]=function(e,r){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return n.makeReq(_extends({},t,{method:a,url:e,data:r}))}})}},{key:"errorToast",value:function(e){var r=e.msg||e.err_msg||e.error&&e.error.message||"操作失败，请稍后重试";setTimeout(function(){_index2.default.showToast({icon:"none",title:r})},200)}},{key:"makeReq",value:function(e){var a=this,r=e.url,t=e.data,n=e.header,o=void 0===n?{}:n,i=e.method,d=void 0===i?"GET":i,s=e.showLoading,u=e.showError,l=void 0===u||u,p="get"===d.toLowerCase(),c=/^http/.test(r)?r:""+this.baseURL+r.replace(/^\//,""),f=t&&"string"!=typeof t?t:_index6.default.parse(t);p||(o["content-type"]=o["content-type"]||"application/x-www-form-urlencoded"),o.Authorization="Bearer "+_index4.default.getAuthToken();var h=this.options,_=h.company_id,x=h.appid;x&&(o["authorizer-appid"]=x);var v=_extends({},e,{url:c,data:f,method:d.toUpperCase(),header:o});return s&&_index2.default.showLoading({mask:!0}),v.data=_extends({},v.data||{},{company_id:_}),"GET"===v.method?(v.url=addQuery(v.url,_index6.default.stringify(v.data)),delete v.data):v.data=_index6.default.stringify(v.data),_index2.default.request(v).then(function(e){var r=e.data,t=e.statusCode;e.header;return s&&_index2.default.hideLoading(),200<=t&&t<300?void 0!==r.data?(0<=v.url.indexOf("token/refresh")&&(r.data.token=e.header.Authorization.replace("Bearer ","")),r.data):(l&&a.errorToast(r),Promise.reject(a.reqError(e))):401===t?(_index4.default.logout(),l&&(r.err_msg=r.err_msg||"登录过期正在重新登录",a.errorToast(r)),_index2.default.redirectTo({url:"/pages/auth/wxauth"}),Promise.reject(a.reqError(e))):400<=t?(l&&a.errorToast(r),Promise.reject(a.reqError(e))):Promise.reject(a.reqError(e,"API error: "+t))})}},{key:"reqError",value:function(e){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",t=e.data.error||e.data,a=t.message||t.err_msg||r,n=new Error(a);return n.res=e,n}}]),n}();exports.default=new API({baseURL:"https://bbc54.shopex123.com/index.php/api/h5app/wxapp"}),exports.API=API;