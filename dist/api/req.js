"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.API=void 0;var _extends=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},_createClass=function(){function n(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,r,t){return r&&n(e.prototype,r),t&&n(e,t),e}}(),_index=require("../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../spx/index.js"),_index4=_interopRequireDefault(_index3),_index5=require("../npm/qs/lib/index.js"),_index6=_interopRequireDefault(_index5);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectDestructuringEmpty(e){if(null==e)throw new TypeError("Cannot destructure undefined")}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function addQuery(e,r){return e+(0<=e.indexOf("?")?"&":"?")+r}var API=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,n);var r=e.baseURL,t=void 0===r?"/":r;/\/$/.test(t)||(t+="/"),this.options=e,this.baseURL=t,this.genMethods(["get","post","delete","put"])}return _createClass(n,[{key:"genMethods",value:function(e){var a=this;e.forEach(function(n){a[n]=function(e,r){var t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return a.makeReq(_extends({},t,{method:n,url:e,data:r}))}})}},{key:"errorToast",value:function(e){var r=e.msg||e.err_msg||e.error&&e.error.message||"操作失败，请稍后重试";setTimeout(function(){_index2.default.showToast({icon:"none",title:r})},200)}},{key:"makeReq",value:function(e){var n=this,r=e.url,t=e.data,a=e.header,o=void 0===a?{}:a,i=e.method,d=void 0===i?"GET":i,u=e.showLoading,s=e.showError,l=void 0===s||s,c="get"===d.toLowerCase(),f=/^http/.test(r)?r:""+this.baseURL+r.replace(/^\//,""),p=t&&"string"!=typeof t?t:_index6.default.parse(t);c||(o["content-type"]=o["content-type"]||"application/x-www-form-urlencoded"),o.Authorization="Bearer "+_index4.default.getAuthToken();var h=1,x=wx.getExtConfigSync?wx.getExtConfigSync():{};x.appid&&(o["authorizer-appid"]=x.appid),x.company_id&&(h=x.company_id);var _=_extends({},e,{url:f,data:p,method:d.toUpperCase(),header:o});return u&&_index2.default.showLoading({mask:!0}),_objectDestructuringEmpty(wx.getExtConfigSync?wx.getExtConfigSync():{}),_.data=_extends({},_.data||{},{company_id:h}),"GET"===_.method?(_.url=addQuery(_.url,_index6.default.stringify(_.data)),delete _.data):_.data=_index6.default.stringify(_.data),_index2.default.request(_).then(function(e){var r=e.data,t=e.statusCode;e.header;return u&&_index2.default.hideLoading(),200<=t&&t<300?void 0!==r.data?(0<=_.url.indexOf("token/refresh")&&(r.data.token=e.header.Authorization.replace("Bearer ","")),r.data):(l&&n.errorToast(r),Promise.reject(n.reqError(e))):401===t?(_index4.default.logout(),l&&(r.err_msg=r.err_msg||"授权过期请重新授权",n.errorToast(r)),_index2.default.redirectTo({url:"/pages/auth/login"}),Promise.reject(n.reqError(e))):400<=t?(l&&n.errorToast(r),Promise.reject(n.reqError(e))):Promise.reject(n.reqError(e,"API error: "+t))})}},{key:"reqError",value:function(e){var r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",t=e.data||{},n=t.msg||t.err_msg||r,a=new Error(n);return a.res=e,a}}]),n}();exports.default=new API({baseURL:"https://bbc54.shopex123.com/index.php/api/h5app/wxapp"}),exports.API=API;