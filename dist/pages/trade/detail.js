"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_createClass=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),_get=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,r,n)}if("value"in i)return i.value;var o=i.get;return void 0!==o?o.call(n):void 0},_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../utils/index.js"),_index4=require("../../api/index.js"),_index5=_interopRequireDefault(_index4),_index6=require("../../spx/index.js"),_index7=_interopRequireDefault(_index6);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(a,o){return function t(e,r){try{var n=s[e](r),i=n.value}catch(e){return void o(e)}if(!n.done)return Promise.resolve(i).then(function(e){t("next",e)},function(e){t("throw",e)});a(i)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var TradeDetail=(_temp2=_class=function(e){function s(){var e,t,n,i=this;_classCallCheck(this,s);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return(t=n=_possibleConstructorReturn(this,(e=s.__proto__||Object.getPrototypeOf(s)).call.apply(e,[this].concat(a)))).$usedState=["anonymousState__temp","anonymousState__temp2","anonymousState__temp3","info","timer","isDhPoint","payLoading"],n.handleCopy=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.state.info,r="收货人："+t.receiver_name+" "+t.receiver_mobile+"\n收货地址："+t.receiver_state+t.receiver_city+t.receiver_district+t.receiver_address+"\n订单编号："+t.tid+"\n创建时间："+t.created_time_str+"\n",e.next=4,(0,_index3.copyText)(r);case 4:case"end":return e.stop()}},e,i)})),n.handleClickDelivery=function(){},n.handleClickToDelivery=function(){},n.handleClickCopy=function(e){(0,_index3.copyText)(e),_index7.default.toast("复制成功")},n.countDownEnd=function(){n.fetch()},n.$$refs=[],_possibleConstructorReturn(n,t)}var r,t,n,i;return _inherits(s,_index.Component),_createClass(s,[{key:"_constructor",value:function(e){_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"_constructor",this).call(this,e),this.state={info:null,timer:null,payLoading:!1}}},{key:"componentDidShow",value:function(){this.fetch()}},{key:"calcTimer",value:function(e){var t=e,r=Math.floor(e/24/3600);t-=3600*r*24;var n=Math.floor(t/3600);t-=3600*n;var i=Math.floor(t/60);return t-=60*i,{dd:r,hh:n,mm:i,ss:Math.floor(t)}}},{key:"fetch",value:(i=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.$router.params.id,e.next=3,_index5.default.trade.detail(t);case 3:r=e.sent,n=(0,_index3.pickBy)(r.orderInfo,{tid:"order_id",created_time_str:function(e){var t=e.create_time;return(0,_index3.formatTime)(1e3*t)},auto_cancel_seconds:"auto_cancel_seconds",receiver_name:"receiver_name",receiver_mobile:"receiver_mobile",receiver_state:"receiver_state",discount_fee:function(e){return(+e.discount_fee/100).toFixed(2)},receiver_city:"receiver_city",receiver_district:"receiver_district",receiver_address:"receiver_address",status_desc:"order_status_msg",delivery_code:"delivery_code",delivery_corp:"delivery_corp",order_type:"order_type",order_status_msg:"order_status_msg",order_status_des:"order_status_des",item_fee:function(e){return(+e.item_fee/100).toFixed(2)},coupon_discount:function(e){return(+e.coupon_discount/100).toFixed(2)},freight_fee:function(e){return(+e.freight_fee/100).toFixed(2)},payment:function(e){var t=e.pay_type,r=e.total_fee;return"dhpoint"===t?Math.floor(r):(+r/100).toFixed(2)},pay_type:"pay_type",invoice_content:"invoice.content",point:"point",status:function(e){var t=e.order_status;return(0,_index3.resolveOrderStatus)(t)},orders:function(e){var t=e.items;return(0,_index3.pickBy)(t,{order_id:"order_id",item_id:"item_id",aftersales_status:"aftersales_status",pic_path:"pic",title:"item_name",delivery_status:"delivery_status",price:function(e){return(+e.item_fee/100).toFixed(2)},point:"item_point",num:"num"})}}),i=null,n.auto_cancel_seconds&&(i=this.calcTimer(n.auto_cancel_seconds),this.setState({timer:i})),a=(n.status||"").toLowerCase(),n.auto_cancel_seconds<=0&&"NOTPAY"===n.order_status_des&&(n.status="TRADE_CLOSED",n.order_status_msg="已取消"),n.status_img="ico_"+("trade_success"===a?"wait_rate":a)+".png",_index3.log.debug("[trade info] info: ",n),this.setState({info:n});case 12:case"end":return e.stop()}},e,this)})),function(){return i.apply(this,arguments)})},{key:"handlePay",value:(n=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,i,a,o,s,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.state.info,this.setState({payLoading:!0}),r=t.tid,n=t.order_type,i={pay_type:"amorepay",order_id:r,order_type:n},e.next=6,_index5.default.cashier.getPayment(i);case 6:return a=e.sent,this.setState({payLoading:!1}),o=void 0,e.prev=9,e.next=12,_index2.default.requestPayment(a);case 12:s=e.sent,_index3.log.debug("[order pay]: ",s),e.next=20;break;case 16:e.prev=16,e.t0=e.catch(9),o=e.t0,e.t0.errMsg.indexOf("cancel")<0&&_index2.default.showToast({title:e.t0.err_desc||e.t0.errMsg||"支付失败",icon:"none"});case 20:if(o){e.next=26;break}try{_index5.default.trade.tradeQuery(a.trade_info.trade_id)}catch(e){console.info(e)}return e.next=24,_index2.default.showToast({title:"支付成功",icon:"success"});case 24:u=(0,_index3.getCurrentRoute)(this.$router),c=u.fullPath,_index2.default.redirectTo({url:c});case 26:case"end":return e.stop()}},e,this,[[9,16]])})),function(){return n.apply(this,arguments)})},{key:"handleClickBtn",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.state.info,"home"===t)return _index2.default.redirectTo({url:"/pages/index"}),e.abrupt("return");e.next=4;break;case 4:if("contact"===t&&_index2.default.makePhoneCall({phoneNumber:"021-61255625"}),"pay"===t)return e.next=8,this.handlePay();e.next=9;break;case 8:return e.abrupt("return");case 9:if("cancel"===t)return _index2.default.navigateTo({url:"/pages/trade/cancel?order_id="+r.tid}),e.abrupt("return");e.next=12;break;case 12:if("confirm"===t)return e.next=15,_index2.default.showModal({title:"确认收货？",content:""});e.next=23;break;case 15:if(n=e.sent,n.confirm)return e.next=20,_index5.default.trade.confirm(r.tid);e.next=22;break;case 20:i=(0,_index3.getCurrentRoute)(this.$router),a=i.fullPath,_index2.default.redirectTo({url:a});case 22:return e.abrupt("return");case 23:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"handleClickRefund",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=this.state.info.tid,"refund"===t?_index2.default.navigateTo({url:"/pages/trade/refund?order_id="+n+"&item_id="+r}):"refundDetail"===t&&_index2.default.navigateTo({url:"/pages/trade/refund-detail?order_id="+n+"&item_id="+r});case 2:case"end":return e.stop()}},e,this)})),function(e,t){return r.apply(this,arguments)})},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};arguments[2];var e=this.__state,t=e.info;e.timer,e.payLoading;if(!t)return null;var r="dhpoint"===t.pay_type,n="WAIT_BUYER_PAY"===t.status?(0,_index3.classNames)("trade-detail-header","trade-detail-header__waitpay"):null,i="WAIT_BUYER_PAY"===t.status?{hours:":",minutes:":",seconds:""}:null,a="WAIT_BUYER_PAY"!==t.status?(0,_index3.classNames)("trade-detail-header"):null;return Object.assign(this.__state,{anonymousState__temp:n,anonymousState__temp2:i,anonymousState__temp3:a,isDhPoint:r}),this.__state}}]),s}(),_class.properties={},_class.$$events=["countDownEnd","handleClickDelivery","handleClickCopy","handleClickBtn"],_temp2);exports.default=TradeDetail,Component(require("../../npm/@tarojs/taro-weapp/index.js").default.createComponent(TradeDetail,!0));