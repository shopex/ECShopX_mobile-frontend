"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _class,_temp2,_createClass=function(){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}}(),_get=function e(t,r,n){null===t&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,r);if(void 0===a){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,r,n)}if("value"in a)return a.value;var o=a.get;return void 0!==o?o.call(n):void 0},_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../utils/index.js"),_index4=require("../../api/index.js"),_index5=_interopRequireDefault(_index4),_index6=require("../../consts/index.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var s=e.apply(this,arguments);return new Promise(function(i,o){return function t(e,r){try{var n=s[e](r),a=n.value}catch(e){return void o(e)}if(!n.done)return Promise.resolve(a).then(function(e){t("next",e)},function(e){t("throw",e)});i(a)}("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var TradeDetail=(_temp2=_class=function(e){function s(){var e,t,n,a=this;_classCallCheck(this,s);for(var r=arguments.length,i=Array(r),o=0;o<r;o++)i[o]=arguments[o];return(t=n=_possibleConstructorReturn(this,(e=s.__proto__||Object.getPrototypeOf(s)).call.apply(e,[this].concat(i)))).$usedState=["anonymousState__temp","anonymousState__temp2","anonymousState__temp3","info","timer","payLoading"],n.handleCopy=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.state.info,r="收货人："+t.receiver_name+" "+t.receiver_mobile+"\n收货地址："+t.receiver_state+t.receiver_city+t.receiver_district+t.receiver_address+"\n订单编号："+t.tid+"\n创建时间："+t.created_time_str+"\n",e.next=4,(0,_index3.copyText)(r);case 4:case"end":return e.stop()}},e,a)})),n.handleClickDelivery=function(){_index2.default.navigateTo({url:"/pages/trade/delivery-info?order_id="+n.state.info.tid})},n.handleClickToDelivery=function(){},n.$$refs=[],_possibleConstructorReturn(n,t)}var r,t,n,a;return _inherits(s,_index.Component),_createClass(s,[{key:"_constructor",value:function(e){_get(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"_constructor",this).call(this,e),this.state={info:null,timer:null,payLoading:!1}}},{key:"componentDidMount",value:function(){this.fetch()}},{key:"calcTimer",value:function(e){var t=e,r=Math.floor(e/24/3600);t-=3600*r*24;var n=Math.floor(t/3600);t-=3600*n;var a=Math.floor(t/60);return t-=60*a,{dd:r,hh:n,mm:a,ss:Math.floor(t)}}},{key:"fetch",value:(a=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.$router.params.id,e.next=3,_index5.default.trade.detail(t);case 3:r=e.sent,n=(0,_index3.pickBy)(r.orderInfo,{tid:"order_id",created_time_str:function(e){var t=e.create_time;return(0,_index3.formatTime)(1e3*t)},auto_cancel_seconds:"auto_cancel_seconds",receiver_name:"receiver_name",receiver_mobile:"receiver_mobile",receiver_state:"receiver_state",receiver_city:"receiver_city",receiver_district:"receiver_district",receiver_address:"receiver_address",status_desc:"order_status_msg",delivery_code:"delivery_code",delivery_corp:"delivery_corp",order_type:"order_type",order_status_msg:"order_status_msg",item_fee:function(e){return(+e.item_fee/100).toFixed(2)},coupon_discount:function(e){return(+e.coupon_discount/100).toFixed(2)},post_fee:function(e){return(+e.freight_fee/100).toFixed(2)},payment:function(e){return(+e.total_fee/100).toFixed(2)},pay_type:"pay_type",point:"point",status:function(e){var t=e.order_status;return(0,_index3.resolveOrderStatus)(t)},orders:function(e){var t=e.items;return(0,_index3.pickBy)(t,{order_id:"order_id",item_id:"item_id",aftersales_status:function(e){var t=e.aftersales_status;return _index6.AFTER_SALE_STATUS[t]},pic_path:"pic",title:"item_name",delivery_status:"delivery_status",price:function(e){return(+e.item_fee/100).toFixed(2)},point:"item_point",num:"num"})}}),a=null,n.auto_cancel_seconds&&(a=this.calcTimer(n.auto_cancel_seconds),this.setState({timer:a})),i=(n.status||"").toLowerCase(),n.status_img="ico_"+("trade_success"===i?"wait_rate":i)+".png",_index3.log.debug("[trade info] info: ",n),this.setState({info:n});case 11:case"end":return e.stop()}},e,this)})),function(){return a.apply(this,arguments)})},{key:"handlePay",value:(n=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,i,o,s,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.state.info,this.setState({payLoading:!0}),r=t.tid,n=t.order_type,a={pay_type:"amorepay",order_id:r,order_type:n},e.next=6,_index5.default.cashier.getPayment(a);case 6:return i=e.sent,this.setState({payLoading:!1}),o=void 0,e.prev=9,e.next=12,_index2.default.requestPayment(i);case 12:s=e.sent,_index3.log.debug("[order pay]: ",s),e.next=20;break;case 16:e.prev=16,e.t0=e.catch(9),o=e.t0,e.t0.errMsg.indexOf("cancel")<0&&_index2.default.showToast({title:e.t0.err_desc||e.t0.errMsg||"支付失败",icon:"none"});case 20:if(o){e.next=26;break}try{_index5.default.trade.tradeQuery(i.trade_info.trade_id)}catch(e){console.info(e)}return e.next=24,_index2.default.showToast({title:"支付成功",icon:"success"});case 24:u=(0,_index3.getCurrentRoute)(this.$router),c=u.fullPath,_index2.default.redirectTo({url:c});case 26:case"end":return e.stop()}},e,this,[[9,16]])})),function(){return n.apply(this,arguments)})},{key:"handleClickBtn",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.state.info,"home"===t)return _index2.default.redirectTo({url:"/pages/home/index"}),e.abrupt("return");e.next=4;break;case 4:if("pay"===t)return e.next=7,this.handlePay();e.next=8;break;case 7:return e.abrupt("return");case 8:if("cancel"===t)return _index2.default.navigateTo({url:"/pages/trade/cancel?order_id="+r.tid}),e.abrupt("return");e.next=11;break;case 11:if("confirm"===t)return e.next=14,_index2.default.showModal({title:"确认收货？",content:""});e.next=22;break;case 14:if(n=e.sent,n.confirm)return e.next=19,_index5.default.trade.confirm(r.tid);e.next=21;break;case 19:a=(0,_index3.getCurrentRoute)(this.$router),i=a.fullPath,_index2.default.redirectTo({url:i});case 21:return e.abrupt("return");case 22:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"handleClickRefund",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=this.state.info.tid,"refund"===t?_index2.default.navigateTo({url:"/pages/trade/refund?order_id="+n+"&item_id="+r}):"refundDetail"===t&&_index2.default.navigateTo({url:"/pages/trade/refund-detail?order_id="+n+"&item_id="+r});case 2:case"end":return e.stop()}},e,this)})),function(e,t){return r.apply(this,arguments)})},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};arguments[2];var e=this.__state,t=e.info;e.timer,e.payLoading;if(!t)return null;var r="WAIT_BUYER_PAY"===t.status?(0,_index3.classNames)("trade-detail-header","trade-detail-header__waitpay"):null,n="WAIT_BUYER_PAY"===t.status?{minutes:":",seconds:""}:null,a="WAIT_BUYER_PAY"!==t.status?(0,_index3.classNames)("trade-detail-header"):null;return Object.assign(this.__state,{anonymousState__temp:r,anonymousState__temp2:n,anonymousState__temp3:a}),this.__state}}]),s}(),_class.properties={},_class.$$events=["handleClickDelivery","handleClickBtn"],_temp2);exports.default=TradeDetail,Component(require("../../npm/@tarojs/taro-weapp/index.js").default.createComponent(TradeDetail,!0));