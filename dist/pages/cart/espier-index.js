"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _dec,_dec2,_class,_class2,_temp2,_initialiseProps,_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},_createClass=function(){function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}(),_get=function t(e,n,r){null===e&&(e=Function.prototype);var a=Object.getOwnPropertyDescriptor(e,n);if(void 0===a){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in a)return a.value;var o=a.get;return void 0!==o?o.call(r):void 0},_index=require("../../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_index3=require("../../npm/@tarojs/redux/index.js"),_index4=require("../../utils/index.js"),_debounce=require("../../npm/lodash/debounce.js"),_debounce2=_interopRequireDefault(_debounce),_index5=require("../../api/index.js"),_index6=_interopRequireDefault(_index5),_index7=require("../../hocs/index.js"),_cart=require("../../store/cart.js");function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _asyncToGenerator(t){return function(){var s=t.apply(this,arguments);return new Promise(function(i,o){return function e(t,n){try{var r=s[t](n),a=r.value}catch(t){return void o(t)}if(!r.done)return Promise.resolve(a).then(function(t){e("next",t)},function(t){e("throw",t)});i(a)}("next")})}}function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var CartIndex=(_dec=(0,_index3.connect)(function(t){var e=t.cart;return{list:e.list,cartIds:e.cartIds,defaultAllSelect:!1,totalPrice:(0,_cart.getTotalPrice)(e),totalItems:(0,_cart.getTotalCount)(e,!0)}},function(n){return{onUpdateCartNum:function(t,e){return n({type:"cart/updateNum",payload:{cart_id:t,num:+e}})},onUpdateCart:function(t){return n({type:"cart/update",payload:t})},onCartSelection:function(t){return n({type:"cart/selection",payload:t})}}}),_dec2=(0,_index7.withLogin)(),_dec(_class=(0,_index7.withPager)(_class=_dec2((_temp2=_class2=function(t){function o(){var t,e,n;_classCallCheck(this,o);for(var r=arguments.length,a=Array(r),i=0;i<r;i++)a[i]=arguments[i];return e=n=_possibleConstructorReturn(this,(t=o.__proto__||Object.getPrototypeOf(o)).call.apply(t,[this].concat(a))),_initialiseProps.call(n),_possibleConstructorReturn(n,e)}var n,r,e,a;return _inherits(o,_index.Component),_createClass(o,[{key:"_constructor",value:function(t){_get(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"_constructor",this).call(this,t),this.state=_extends({},this.state,{loading:!0,selection:new Set,cartMode:"default",curPromotions:null,groups:[],likeList:[],invalidList:[],error:null}),this.updating=!1,this.lastCartId=null}},{key:"componentDidMount",value:function(){var r=this;this.fetchCart(function(t){r.props.defaultAllSelect&&r.handleAllSelect(!0);var e=r.resolveActivityGroup(t),n=[];t.forEach(function(t){var e=t.list.filter(function(t){return t.is_checked}).map(function(t){return t.cart_id});n=[].concat(_toConsumableArray(n),_toConsumableArray(e))}),r.updateSelection(n),setTimeout(function(){r.setState({groups:e,loading:!1})},40)}),this.nextPage()}},{key:"componentDidShow",value:function(){this.state.loading||this.updateCart()}},{key:"componentWillReceiveProps",value:function(t){if(t.list!==this.props.list){var e=this.resolveActivityGroup(t.list);this.setState({groups:e})}}},{key:"fetch",value:(a=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var n,r,a,i,o,s,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.page_no,r=e.page_size,a={page:n,pageSize:r},t.next=4,_index6.default.cart.likeList(a);case 4:return i=t.sent,o=i.list,s=i.total_count,c=(0,_index4.pickBy)(o,{img:"pics[0]",item_id:"item_id",title:"itemName",desc:"brief"}),this.setState({likeList:[].concat(_toConsumableArray(this.state.likeList),_toConsumableArray(c))}),t.abrupt("return",{total:s});case 10:case"end":return t.stop()}},t,this)})),function(t){return a.apply(this,arguments)})},{key:"resolveActivityGroup",value:function(t){return t.map(function(t){var e=t.list,n=t.used_activity,r=void 0===n?[]:n,a=e.reduce(function(t,e){return t[e.cart_id]=e,t},{}),i=t.activity_grouping,o=r.map(function(e){var t=i.find(function(t){return String(t.activity_id)===String(e.activity_id)}),n=t.cart_ids.map(function(t){var e=a[t];return delete a[t],e});return{activity:t,list:n}});return o.push({activity:null,list:Object.values(a)}),o})}},{key:"processCart",value:function(t){var n=this,e=t.valid_cart,r=void 0===e?[]:e,a=t.invalid_cart,i=void 0===a?[]:a,o=r.map(function(t){var e=n.transformCartList(t.list);return _extends({},t,{list:e})}),s=this.transformCartList(i);return this.setState({invalidList:s}),_index4.log.debug("[cart fetchCart]",o),this.__triggerPropsFn("onUpdateCart",[null].concat([o])),o}},{key:"fetchCart",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var n,r,a,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=[],r=[],t.prev=1,t.next=4,_index6.default.cart.get();case 4:a=t.sent,n=a.valid_cart||n,r=a.invalid_cart||r,t.next=12;break;case 9:t.prev=9,t.t0=t.catch(1),this.setState({error:t.t0});case 12:i=this.processCart({valid_cart:n,invalid_cart:r}),e&&e(i);case 14:case"end":return t.stop()}},t,this,[[1,9]])})),function(t){return e.apply(this,arguments)})},{key:"updateSelection",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];this.setState({selection:new Set(t)}),this.__triggerPropsFn("onCartSelection",[null].concat([t]))}},{key:"handleSelectionChange",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function t(e,n){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return(r=this.state.selection)[n?"add":"delete"](e),this.updateSelection([].concat(_toConsumableArray(r))),t.next=5,_index6.default.cart.select({cart_id:e,is_checked:n});case 5:_index4.log.debug("[cart change] item: "+e+", selection:",r),this.updateCart();case 7:case"end":return t.stop()}},t,this)})),function(t,e){return r.apply(this,arguments)})},{key:"changeCartNum",value:(n=_asyncToGenerator(regeneratorRuntime.mark(function t(e,n){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,_index6.default.cart.updateNum(e,n);case 2:r=t.sent,this.processCart(r);case 4:case"end":return t.stop()}},t,this)})),function(t,e){return n.apply(this,arguments)})},{key:"transformCartList",value:function(t){return(0,_index4.pickBy)(t,{item_id:"item_id",cart_id:"cart_id",activity_id:"activity_id",title:"item_name",desc:"brief",is_checked:"is_checked",store:"store",curSymbol:"cur.symbol",promotions:function(t){var e=t.promotions,n=void 0===e?[]:e,r=t.cart_id;return n.map(function(t){return t.cart_id=r,t})},img:function(t){return t.pics},price:function(t){return(+t.price/100).toFixed(2)},market_price:function(t){return(+t.market_price/100).toFixed(2)},num:"num"})}},{key:"_createData",value:function(){this.__state=arguments[0]||this.state||{},this.__props=arguments[1]||this.props||{};arguments[2];var t=this.__state,r=t.selection,e=t.groups,n=(t.invalidList,t.cartMode),a=t.loading,i=t.curPromotions,o=(t.likeList,t.page),s=this.__props,c=s.totalPrice,u=s.list;if(a)return null;var l=r.size,d=!u.length;console.log(u,427);var p=u.length&&0<u[0].discount_fee&&"edit"!==n?-1*u[0].discount_fee:null,_="edit"!==n?l<=0:null,f=Boolean(i),h=e.map(function(t,e){return{$anonymousCallee__1:(t={$original:(0,_index.internal_get_original)(t)}).$original.map(function(n){return n={$original:(0,_index.internal_get_original)(n)},console.log(n.$original),{activity:n.$original.activity,$anonymousCallee__0:0<n.$original.list.length?n.$original.list.map(function(t){t={$original:(0,_index.internal_get_original)(t)};var e=0<n.$original.list.length?r.has(t.$original.cart_id):null;return{activity:n.activity,$loopState__temp2:e,$original:t.$original}}):[],$original:n.$original}}),$original:t.$original}});return Object.assign(this.__state,{anonymousState__temp3:p,anonymousState__temp4:_,anonymousState__temp5:f,loopArray0:h,isEmpty:d,list:u,page:o,totalPrice:c,isTotalChecked:this.isTotalChecked}),this.__state}},{key:"isTotalChecked",get:function(){return this.props.cartIds.length===this.state.selection.size}}]),o}(),_class2.properties={defaultAllSelect:{type:null,value:null},list:{type:null,value:null},__fn_onUpdateCart:{type:null,value:null},cartIds:{type:null,value:null},__fn_onCartSelection:{type:null,value:null},__fn_onUpdateCartNum:{type:null,value:null},totalPrice:{type:null,value:null}},_class2.$$events=["nextPage","handleQuantityChange","handleClickPromotion","handleClickToDetail","handleSelectionChange","handleDelect","navigateTo","handleClickItem","handleAllSelect","handleCheckout","handleClosePromotions","handleSelectPromotion"],_class2.defaultProps={totalPrice:"0.00",list:null},_initialiseProps=function(){var e,r,n,a,o=this;this.$usedState=["anonymousState__temp3","anonymousState__temp4","anonymousState__temp5","loopArray0","loading","isEmpty","groups","list","invalidList","likeList","page","cartMode","totalPrice","curPromotions","selection","error","defaultAllSelect","__fn_onUpdateCart","cartIds","__fn_onCartSelection","__fn_onUpdateCartNum","isTotalChecked"],this.handleClickItem=function(t){var e="/pages/item/espier-detail?id="+t.item_id;_index2.default.navigateTo({url:e})},this.updateCart=_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return _index2.default.showLoading({mask:!0}),o.updating=!0,t.prev=2,t.next=5,o.fetchCart();case 5:t.next=10;break;case 7:t.prev=7,t.t0=t.catch(2),console.log(t.t0);case 10:o.updating=!1,_index2.default.hideLoading();case 12:case"end":return t.stop()}},t,o,[[2,7]])})),this.asyncUpdateCart=(0,_debounce2.default)(_asyncToGenerator(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,o.updateCart();case 2:case"end":return t.stop()}},t,o)})),300),this.toggleCartMode=function(){var t="edit"!==o.state.cartMode?"edit":"default";o.setState({cartMode:t})},this.handleDelect=(e=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,_index2.default.showModal({title:"将当前商品移出购物车?",showCancel:!0,cancel:"取消",confirmText:"确认",confirmColor:"#0b4137"});case 2:if(t.sent.confirm){t.next=5;break}return t.abrupt("return");case 5:return t.next=7,_index6.default.cart.del({cart_id:e});case 7:n=o.props.cartIds.filter(function(t){return t!==e}),o.updateSelection(n),o.updateCart();case 10:case"end":return t.stop()}},t,o)})),function(t){return e.apply(this,arguments)}),this.handleQuantityChange=(r=_asyncToGenerator(regeneratorRuntime.mark(function t(e,n,r){var a,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r.stopPropagation(),a=e.item_id,i=e.cart_id,_index2.default.showLoading({mask:!0}),o.__triggerPropsFn("onUpdateCartNum",[null].concat([i,n])),t.next=6,o.changeCartNum(a,n);case 6:_index2.default.hideLoading();case 7:case"end":return t.stop()}},t,o)})),function(t,e,n){return r.apply(this,arguments)}),this.handleAllSelect=(n=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var n,r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=o.state.selection,r=o.props.cartIds,e?r.forEach(function(t){return n.add(t)}):n.clear(),_index2.default.showLoading(),t.prev=4,t.next=7,_index6.default.cart.select({cart_id:r,is_checked:e});case 7:t.next=12;break;case 9:t.prev=9,t.t0=t.catch(4),console.log(t.t0);case 12:_index2.default.hideLoading(),o.updateSelection([].concat(_toConsumableArray(n)));case 14:case"end":return t.stop()}},t,o,[[4,9]])})),function(t){return n.apply(this,arguments)}),this.handleClickPromotion=function(e,t){var n=void(o.isTodetail=0);o.props.list.some(function(t){t.list.some(function(t){t.cart_id===e&&(n=t.promotions.slice())})}),o.setState({curPromotions:n},function(){o.isTodetail=1})},this.handleClickToDetail=function(t){if(0===o.isTodetail)return!1;o.isTodetail=1,_index2.default.navigateTo({url:"/pages/item/espier-detail?id="+t})},this.handleSelectPromotion=(a=_asyncToGenerator(regeneratorRuntime.mark(function t(e){var n,r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.marketing_id,r=e.cart_id,_index2.default.showLoading({mask:!0}),o.setState({curPromotions:null}),t.next=5,_index6.default.cart.updatePromotion({activity_id:n,cart_id:r});case 5:return t.next=7,o.fetchCart();case 7:_index2.default.hideLoading();case 8:case"end":return t.stop()}},t,o)})),function(t){return a.apply(this,arguments)}),this.handleClosePromotions=function(){o.setState({curPromotions:null})},this.handleCheckout=function(){o.updating?_index2.default.showToast({title:"正在计算价格，请稍后",icon:"none"}):_index2.default.navigateTo({url:"/pages/cart/espier-checkout?cart_type=cart"})},this.navigateTo=function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];_index4.navigateTo.apply(o,e)},this.$$refs=[]},_class=_temp2))||_class)||_class)||_class);exports.default=CartIndex,Component(require("../../npm/@tarojs/taro-weapp/index.js").default.createComponent(CartIndex,!0));