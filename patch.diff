From 44374bf21349cd7554214ece861142e632f5a291 Mon Sep 17 00:00:00 2001
From: lukaijie <lukaijie@shopex.cn>
Date: Sat, 9 Apr 2022 23:33:32 +0800
Subject: [PATCH] chore(release): 2.6.0

---
 CHANGELOG.md      | 7 +++++++
 package-lock.json | 2 +-
 package.json      | 2 +-
 3 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/CHANGELOG.md b/CHANGELOG.md
index 8d2a8382..42e71aed 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -2,6 +2,13 @@
 
 All notable changes to this project will be documented in this file. See [standard-version](https://github.com/conventional-changelog/standard-version) for commit guidelines.
 
+## [2.6.0](https://git.ishopex.cn/ecshopx/ecshopx-vshop/compare/v2.5.1...v2.6.0) (2022-04-09)
+
+
+### Features
+
+* test ([ba3e216](https://git.ishopex.cn/ecshopx/ecshopx-vshop/commit/ba3e21626e137e343f7df75d5c2fca5f47b766b3))
+
 ### [2.5.1](https://git.ishopex.cn/ecshopx/ecshopx-vshop/compare/v2.5.0...v2.5.1) (2022-04-09)
 
 
diff --git a/package-lock.json b/package-lock.json
index 0d934211..3bd19d4a 100644
--- a/package-lock.json
+++ b/package-lock.json
@@ -1,6 +1,6 @@
 {
   "name": "ecshopx-vshop",
-  "version": "2.5.1",
+  "version": "2.6.0",
   "lockfileVersion": 1,
   "requires": true,
   "dependencies": {
diff --git a/package.json b/package.json
index 8e01d276..12fd8fcc 100644
--- a/package.json
+++ b/package.json
@@ -1,7 +1,7 @@
 {
   "name": "ecshopx-vshop",
   "app_name": "ecshopx",
-  "version": "2.5.1",
+  "version": "2.6.0",
   "private": true,
   "description": "taro app for bbc",
   "scripts": {
-- 
2.23.0

From 0e4eaace1bf8f56b012d0dda0018adc1e3c93eae Mon Sep 17 00:00:00 2001
From: lukaijie <lukaijie@shopex.cn>
Date: Mon, 11 Apr 2022 12:23:55 +0800
Subject: [PATCH] =?UTF-8?q?fix:=20=E4=BF=AE=E6=94=B9=E6=A0=87=E9=A2=98?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 src/app.config.js | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/app.config.js b/src/app.config.js
index 7b7b3210..2f5d2ead 100644
--- a/src/app.config.js
+++ b/src/app.config.js
@@ -243,7 +243,7 @@ export default {
   window: {
     'backgroundTextStyle': 'light',
     'navigationBarBackgroundColor': '#fff',
-    'navigationBarTitleText': '微商城',
+    'navigationBarTitleText': 'ECShopX免费',
     'navigationBarTextStyle': 'black'
   }
 }
-- 
2.23.0

From 57f4f1856a7150a4bab6602fe20a5dd8f923e557 Mon Sep 17 00:00:00 2001
From: lukaijie <lukaijie@shopex.cn>
Date: Mon, 11 Apr 2022 12:22:26 +0800
Subject: [PATCH] fix

---
 .env                              | 10 +++----
 src/ext.json                      |  4 +--
 src/pages/cart/const/index.js     |  7 +++++
 src/pages/cart/espier-checkout.js | 44 +++++++++++++++++++++++++++++--
 src/pages/item/espier-detail.js   |  2 +-
 src/pages/item/espier-detail.scss | 10 ++++---
 src/pages/store/index.js          | 32 +++++++++++++++++++---
 src/pages/store/index.scss        | 32 ++++++++++++----------
 8 files changed, 110 insertions(+), 31 deletions(-)

diff --git a/.env b/.env
index 1c9758b7..d061b0d0 100644
--- a/.env
+++ b/.env
@@ -1,13 +1,13 @@
-APP_BASE_URL=https://{域名}/api/h5app/wxapp
-APP_WEBSOCKET=wss://{域名}/ws
+APP_BASE_URL=https://ecshopx1.shopex123.com/api/h5app/wxapp
+APP_WEBSOCKET=wss://ecshopx1.shopex123.com/ws
 APP_COMPANY_ID=1
 APP_PLATFORM=platform
-APP_CUSTOM_SERVER=https://{域名}
+APP_CUSTOM_SERVER=https://ecshopx-h5.ex-sandbox.com/
 APP_HOME_PAGE=/pages/index
 APP_TRACK=youshu
 APP_YOUSHU_TOKEN=bi281e87ab2424481a
-APP_ID={小程序APPID}
-APP_MAP_KEY={高德地图key}
+APP_ID=wx3e1c17c88abf3e45
+APP_MAP_KEY=1ccc1ebc947719886f0cd766d70241fe
 APP_MAP_NAME=oneX新零售门店定位
 APP_IMAGE_CDN=https://b-img-cdn.yuanyuanke.cn/ecshopx-vshop
 
diff --git a/src/ext.json b/src/ext.json
index 7d81d184..418229bf 100644
--- a/src/ext.json
+++ b/src/ext.json
@@ -1,9 +1,9 @@
 {
   "extEnable": true,
-  "extAppid": "{小程序APPID}",
+  "extAppid": "wx3e1c17c88abf3e45",
   "ext": {
     "company_id": "1",
-    "appid": "{小程序APPID}",
+    "appid": "wx3e1c17c88abf3e45",
     "wxa_name": "通用小程序",
     "ali_isvid":""
   },
diff --git a/src/pages/cart/const/index.js b/src/pages/cart/const/index.js
index 930dadcb..9cb1e0be 100644
--- a/src/pages/cart/const/index.js
+++ b/src/pages/cart/const/index.js
@@ -36,6 +36,13 @@ export const initialState = {
   isPointOpen: false,
   point_use: 0,
   pointInfo: {},
+  streetCommunityList: [],
+  openStreet: false,
+  multiValue: [],
+  multiIndex: [0, 0],
+  streetCommunityTxt: '请选择',
+  street: null, // 街道
+  community: null, // 社区
   isPaymentOpend: false,
   isPackageOpend: false,
   isNeedPackage: false, // 是否需要打包
diff --git a/src/pages/cart/espier-checkout.js b/src/pages/cart/espier-checkout.js
index c0e6bdc2..ee787940 100644
--- a/src/pages/cart/espier-checkout.js
+++ b/src/pages/cart/espier-checkout.js
@@ -3,7 +3,7 @@ import { useSelector, useDispatch } from 'react-redux'
 import Taro, { getCurrentInstance } from '@tarojs/taro'
 import { AtButton, AtInput } from 'taro-ui'
 import { SpPage, SpPrice, SpCell, SpOrderItem, SpCashier, SpGoodsCell } from '@/components'
-import { View, Text } from '@tarojs/components'
+import { View, Text, Picker } from '@tarojs/components'
 import { changeCoupon } from '@/store/slices/cart'
 import { updateChooseAddress } from '@/store/slices/user'
 import { changeZitiStore } from '@/store/slices/shop'
@@ -74,6 +74,13 @@ function CartCheckout(props) {
     isPointOpenModal,
     point_use,
     pointInfo,
+    streetCommunityList,
+    openStreet,
+    multiValue,
+    multiIndex,
+    streetCommunityTxt,
+    street,
+    community,
     isNeedPackage,
     isPackageOpend,
     isPaymentOpend,
@@ -176,6 +183,10 @@ function CartCheckout(props) {
       showToast('该商品已下架')
       return
     }
+    // 校验开始街道、社区
+    if (openStreet && (!street || !community)) {
+      return showToast('请选择街道居委')
+    }
 
     setState(
       (draft) => {
@@ -206,6 +217,11 @@ function CartCheckout(props) {
 
   const handlePay = async () => {
     const params = await getParamsInfo()
+    // 店铺是否开启社区街道
+    if (openStreet) {
+      params['subdistrict_parent_id'] = street
+      params['subdistrict_id'] = community
+    }
     console.log('trade params:', params)
     if (payType === 'deposit') {
       // 验证余额额度是否可用
@@ -438,7 +454,11 @@ function CartCheckout(props) {
       max_point = 0,
       is_open_deduct_point,
       deduct_point_rule,
-      real_use_point
+      real_use_point,
+      // 是否开启下单填写街道、社区
+      is_require_subdistrict: openStreet,
+      subdistrict_parent_id,
+      subdistrict_id
     } = orderRes
 
     if (coupon_info) {
@@ -683,6 +703,26 @@ function CartCheckout(props) {
         />
       </View>
 
+      {/* 街道、社区信息填写 */}
+      {openStreet && (
+        <View className='cart-checkout__stree'>
+          <SpCell isLink title='街道居委'>
+            <Picker
+              mode='multiSelector'
+              onChange={bindMultiPickerChange}
+              onColumnChange={bindMultiPickerColumnChange}
+              value={multiIndex}
+              range={multiValue}
+            >
+              <View className='picker-value'>{streetCommunityTxt}</View>
+            </Picker>
+          </SpCell>
+          <View className='cart-checkout__stree-desc'>
+            <Text className='required'>*</Text>如所选街道居委信息错误，订单将无法配送！
+          </View>
+        </View>
+      )}
+
       {renderGoodsComp()}
 
       {type !== 'limited_time_sale' && type !== 'group' && type !== 'seckill' && !bargain_id && (
diff --git a/src/pages/item/espier-detail.js b/src/pages/item/espier-detail.js
index 9e798380..63f3b6a6 100644
--- a/src/pages/item/espier-detail.js
+++ b/src/pages/item/espier-detail.js
@@ -351,7 +351,7 @@ function EspierDetail(props) {
               Taro.navigateTo({ url: '/subpages/member/index' })
             }}
           >
-            <Text className='iconfont icon-home1'></Text>
+            <Text className='iconfont icon-huiyuanzhongxin'></Text>
           </SpFloatMenuItem>
           <SpChat sessionFrom={JSON.stringify(sessionFrom)}>
             <SpFloatMenuItem>
diff --git a/src/pages/item/espier-detail.scss b/src/pages/item/espier-detail.scss
index 5d6772cb..2f4a396b 100644
--- a/src/pages/item/espier-detail.scss
+++ b/src/pages/item/espier-detail.scss
@@ -28,10 +28,12 @@
       transform: translate(-50%, -50%);
     }
   }
-  .icon-home1,
-  .icon-headphones {
-    font-size: 38px;
-    color: #fff;
+  .float-container {
+    .icon-huiyuanzhongxin,
+    .icon-headphones {
+      font-size: 38px;
+      color: #fff;
+    }
   }
   .btn-video {
     position: absolute;
diff --git a/src/pages/store/index.js b/src/pages/store/index.js
index 1cdba7e4..5d168d70 100644
--- a/src/pages/store/index.js
+++ b/src/pages/store/index.js
@@ -1,8 +1,16 @@
 import { Component } from 'react'
 import { connect } from 'react-redux'
 import Taro, { getCurrentInstance } from '@tarojs/taro'
-import { View, Image, ScrollView } from '@tarojs/components'
-import { SpToast, Loading, BackToTop, SpRecommend, SpCellCoupon, SpPage } from '@/components'
+import { View, Text, ScrollView } from '@tarojs/components'
+import {
+  SpToast,
+  Loading,
+  BackToTop,
+  SpRecommend,
+  SpCellCoupon,
+  SpPage,
+  SpFloatMenuItem
+} from '@/components'
 import { AtTabBar } from 'taro-ui'
 import req from '@/api/req'
 import api from '@/api'
@@ -336,6 +344,24 @@ export default class StoreIndex extends Component {
         })}
         isDefault={storeIsVaild}
         defaultMsg='该店铺已注销，在别的店铺看看吧'
+        renderFloat={
+          <View>
+            <SpFloatMenuItem
+              onClick={() => {
+                Taro.navigateTo({ url: '/subpages/member/index' })
+              }}
+            >
+              <Text className='iconfont icon-huiyuanzhongxin'></Text>
+            </SpFloatMenuItem>
+            <SpFloatMenuItem
+              onClick={() => {
+                Taro.navigateTo({ url: '/pages/cart/espier-index' })
+              }}
+            >
+              <Text className='iconfont icon-gouwuche'></Text>
+            </SpFloatMenuItem>
+          </View>
+        }
       >
         <ScrollView
           className='wgts-wrap wgts-wrap__fixed__page'
@@ -381,7 +407,7 @@ export default class StoreIndex extends Component {
           </View>
         </ScrollView>
 
-        <BackToTop show={showBackToTop} onClick={this.scrollBackToTop} />
+        {/* <BackToTop show={showBackToTop} onClick={this.scrollBackToTop} /> */}
 
         {/* <SpToast /> */}
         <AtTabBar fixed tabList={tabList} onClick={this.handleClick} current={localCurrent} />
diff --git a/src/pages/store/index.scss b/src/pages/store/index.scss
index 1639e932..f321c7d2 100644
--- a/src/pages/store/index.scss
+++ b/src/pages/store/index.scss
@@ -1,4 +1,4 @@
-@import "../../style/imports";
+@import '../../style/imports';
 $primary-color: rgba(244, 129, 31, 1);
 .page-store-height {
   height: 100vh !important;
@@ -7,27 +7,27 @@ $primary-color: rgba(244, 129, 31, 1);
   background: #fff;
   height: 100%;
   box-sizing: border-box;
-  &.fixedSearch{
+  &.fixedSearch {
     .wgts-wrap {
       padding-top: 170px;
       /*  #ifdef  h5  */
       padding-top: 160px;
-      /*  #endif  */   
-    }  
+      /*  #endif  */
+    }
   }
-  .store-header { 
+  .store-header {
     text-align: center;
-    padding:30px 0;
+    padding: 30px 0;
     .store-brand {
       display: inline-block;
       width: 120px;
       height: 120px;
-      box-shadow: 0 0 1PX rgba(0,0,0,0.5);
+      box-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
     }
     .store-name {
       font-size: 32px;
     }
-  } 
+  }
   .add_tip {
     display: flex;
     position: fixed;
@@ -53,7 +53,6 @@ $primary-color: rgba(244, 129, 31, 1);
       font-size: 24px;
       color: #fff;
     }
-
   }
   .add_tip:after {
     content: '';
@@ -74,9 +73,15 @@ $primary-color: rgba(244, 129, 31, 1);
     .distribution-shop {
       width: 100%;
       border-radius: 60px;
-      box-shadow: 0 0 20px rgba(0,0,0,.2);
+      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
     }
   }
+
+  .icon-huiyuanzhongxin,
+  .icon-gouwuche {
+    font-size: 38px;
+    color: #fff;
+  }
 }
 
 .wgts-wrap {
@@ -142,13 +147,14 @@ $primary-color: rgba(244, 129, 31, 1);
       height: 8px;
       background: #333;
       border-radius: 50%;
-      &::before, &::after {
+      &::before,
+      &::after {
         position: absolute;
         width: 8px;
         height: 8px;
         background: #333;
         border-radius: 50%;
-        content: "";
+        content: '';
       }
       &::before {
         transform: translateX(-160%);
@@ -170,9 +176,7 @@ $primary-color: rgba(244, 129, 31, 1);
       padding: 10px;
       box-sizing: border-box;
     }
-  
   }
-  
 }
 
 .grid-goods__type-grid {
-- 
2.23.0

From 4c03a7099c2323589e0064507673dedbd77017d5 Mon Sep 17 00:00:00 2001
From: lukaijie <lukaijie@shopex.cn>
Date: Mon, 11 Apr 2022 16:58:43 +0800
Subject: [PATCH] =?UTF-8?q?fix:=20=E6=B7=BB=E5=8A=A0=E7=A4=BE=E5=8C=BA?=
 =?UTF-8?q?=E8=A1=97=E9=81=93=E5=85=B3=E8=81=94=E5=9C=B0=E5=8C=BA?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 src/api/cart.js                     |   5 ++
 src/pages/cart/espier-checkout.js   | 112 +++++++++++++++++++++++++++-
 src/pages/cart/espier-checkout.scss |  19 +++++
 3 files changed, 135 insertions(+), 1 deletion(-)

diff --git a/src/api/cart.js b/src/api/cart.js
index a08c0350..959697ff 100644
--- a/src/api/cart.js
+++ b/src/api/cart.js
@@ -91,3 +91,8 @@ export function getCartRemind(params) {
 export function exchangeGood(params) {
   return req.post('user/exchangeCard', params)
 }
+
+// 获取街道、社区列表
+export function getSubdistrict(params) {
+  return req.get('/espier/subdistrict', params)
+}
diff --git a/src/pages/cart/espier-checkout.js b/src/pages/cart/espier-checkout.js
index ee787940..96823baf 100644
--- a/src/pages/cart/espier-checkout.js
+++ b/src/pages/cart/espier-checkout.js
@@ -423,6 +423,57 @@ function CartCheckout(props) {
     })
   }
 
+  // 获取街道、社区
+  const getSubdistrict = async ({
+    receiver_state,
+    receiver_city,
+    receiver_district,
+    subdistrict_parent_id,
+    subdistrict_id
+  }) => {
+    let multiValue = []
+    let multiIndex = [0, 0]
+    let streetCommunityList = []
+    let streetCommunityTxt = '请选择'
+    let street = null
+    let community = null
+
+    // 调用街道、社区接口
+    streetCommunityList = await api.cart.getSubdistrict({
+      receiver_state,
+      receiver_city,
+      receiver_district,
+      distributor_id: dtid
+    })
+    if (streetCommunityList.length > 0) {
+      multiValue[0] = streetCommunityList.map((item) => item.label)
+      multiValue[1] = streetCommunityList[0].children.map((item) => item.label)
+      streetCommunityList.forEach((pitem, pindex) => {
+        if (pitem.id == subdistrict_parent_id) {
+          pitem.children.forEach((sitem, sindex) => {
+            if (sitem.id == subdistrict_id) {
+              streetCommunityTxt = `${pitem.label} ${sitem.label}`
+              multiIndex = [pindex, sindex]
+              street = subdistrict_parent_id
+              community = subdistrict_id
+            }
+          })
+        }
+      })
+    } else {
+      showToast('暂无街道、社区配置')
+    }
+
+    return {
+      multiValue,
+      streetCommunityList,
+      multiIndex,
+      streetCommunityTxt,
+      street,
+      community
+    }
+  }
+
   const calcOrder = async () => {
     Taro.showLoading()
     const cus_parmas = await getParamsInfo()
@@ -458,9 +509,24 @@ function CartCheckout(props) {
       // 是否开启下单填写街道、社区
       is_require_subdistrict: openStreet,
       subdistrict_parent_id,
-      subdistrict_id
+      subdistrict_id,
+      receiver_state,
+      receiver_city,
+      receiver_district
     } = orderRes
 
+    let subdistrictRes
+    if (openStreet) {
+      subdistrictRes = await getSubdistrict({
+        receiver_state,
+        receiver_city,
+        receiver_district,
+        subdistrict_parent_id,
+        subdistrict_id
+      })
+    }
+    console.log('subdistrictRes:', subdistrictRes)
+
     if (coupon_info) {
       const info = {
         type: 'coupon',
@@ -523,6 +589,23 @@ function CartCheckout(props) {
       draft.totalInfo = total_info
       draft.paramsInfo = { ...paramsInfo, ...cus_parmas }
       draft.pointInfo = point_info
+      draft.openStreet = openStreet
+      if (openStreet) {
+        const {
+          multiValue,
+          multiIndex,
+          streetCommunityList,
+          streetCommunityTxt,
+          street,
+          community
+        } = subdistrictRes
+        draft.multiValue = multiValue
+        draft.multiIndex = multiIndex
+        draft.streetCommunityList = streetCommunityList
+        draft.streetCommunityTxt = streetCommunityTxt
+        draft.street = street
+        draft.community = community
+      }
     })
     if (extraTips) {
       Taro.showModal({
@@ -626,6 +709,33 @@ function CartCheckout(props) {
     }
   }
 
+  // 街道社区
+  const bindMultiPickerChange = (e) => {
+    const [a, b] = e.detail.value
+    if (streetCommunityList[a].children == 0) {
+      return showToast('居委不能为空')
+    }
+    setState((draft) => {
+      draft.multiIndex = [a, b]
+      draft.streetCommunityTxt = `${streetCommunityList[a].label} ${streetCommunityList[a].children[b].label}`
+      draft.street = streetCommunityList[a].id
+      draft.community = streetCommunityList[a].children[b].id
+    })
+  }
+
+  // 街道社区
+  const bindMultiPickerColumnChange = (e) => {
+    const { column, value } = e.detail
+
+    if (column == 0) {
+      multiValue[1] = streetCommunityList[value].children.map((item) => item.label)
+    }
+    setState((draft) => {
+      draft.multiValue = multiValue
+      // draft.multiIndex = [value, 0]
+    })
+  }
+
   const renderFooter = () => {
     return (
       <View className='checkout-toolbar'>
diff --git a/src/pages/cart/espier-checkout.scss b/src/pages/cart/espier-checkout.scss
index 7fd8730c..a598f7af 100644
--- a/src/pages/cart/espier-checkout.scss
+++ b/src/pages/cart/espier-checkout.scss
@@ -216,4 +216,23 @@ $margin24: 24px;
       }
     }
   }
+
+  .cart-checkout__stree {
+    margin: 0 0 $margin24;
+    .sp-cell {
+      padding: 30px 16px;
+      box-shadow: 0px 2px 10px 0px #eae7e0;
+    }
+    .required {
+      color: #e62424;
+    }
+    &-desc {
+      color: #666;
+      font-size: 24px;
+    }
+    .picker-value {
+      color: #222;
+      text-align: right;
+    }
+  }
 }
-- 
2.23.0

From 4c03a7099c2323589e0064507673dedbd77017d5 Mon Sep 17 00:00:00 2001
From: lukaijie <lukaijie@shopex.cn>
Date: Mon, 11 Apr 2022 16:58:43 +0800
Subject: [PATCH] =?UTF-8?q?fix:=20=E6=B7=BB=E5=8A=A0=E7=A4=BE=E5=8C=BA?=
 =?UTF-8?q?=E8=A1=97=E9=81=93=E5=85=B3=E8=81=94=E5=9C=B0=E5=8C=BA?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 src/api/cart.js                     |   5 ++
 src/pages/cart/espier-checkout.js   | 112 +++++++++++++++++++++++++++-
 src/pages/cart/espier-checkout.scss |  19 +++++
 3 files changed, 135 insertions(+), 1 deletion(-)

diff --git a/src/api/cart.js b/src/api/cart.js
index a08c0350..959697ff 100644
--- a/src/api/cart.js
+++ b/src/api/cart.js
@@ -91,3 +91,8 @@ export function getCartRemind(params) {
 export function exchangeGood(params) {
   return req.post('user/exchangeCard', params)
 }
+
+// 获取街道、社区列表
+export function getSubdistrict(params) {
+  return req.get('/espier/subdistrict', params)
+}
diff --git a/src/pages/cart/espier-checkout.js b/src/pages/cart/espier-checkout.js
index ee787940..96823baf 100644
--- a/src/pages/cart/espier-checkout.js
+++ b/src/pages/cart/espier-checkout.js
@@ -423,6 +423,57 @@ function CartCheckout(props) {
     })
   }
 
+  // 获取街道、社区
+  const getSubdistrict = async ({
+    receiver_state,
+    receiver_city,
+    receiver_district,
+    subdistrict_parent_id,
+    subdistrict_id
+  }) => {
+    let multiValue = []
+    let multiIndex = [0, 0]
+    let streetCommunityList = []
+    let streetCommunityTxt = '请选择'
+    let street = null
+    let community = null
+
+    // 调用街道、社区接口
+    streetCommunityList = await api.cart.getSubdistrict({
+      receiver_state,
+      receiver_city,
+      receiver_district,
+      distributor_id: dtid
+    })
+    if (streetCommunityList.length > 0) {
+      multiValue[0] = streetCommunityList.map((item) => item.label)
+      multiValue[1] = streetCommunityList[0].children.map((item) => item.label)
+      streetCommunityList.forEach((pitem, pindex) => {
+        if (pitem.id == subdistrict_parent_id) {
+          pitem.children.forEach((sitem, sindex) => {
+            if (sitem.id == subdistrict_id) {
+              streetCommunityTxt = `${pitem.label} ${sitem.label}`
+              multiIndex = [pindex, sindex]
+              street = subdistrict_parent_id
+              community = subdistrict_id
+            }
+          })
+        }
+      })
+    } else {
+      showToast('暂无街道、社区配置')
+    }
+
+    return {
+      multiValue,
+      streetCommunityList,
+      multiIndex,
+      streetCommunityTxt,
+      street,
+      community
+    }
+  }
+
   const calcOrder = async () => {
     Taro.showLoading()
     const cus_parmas = await getParamsInfo()
@@ -458,9 +509,24 @@ function CartCheckout(props) {
       // 是否开启下单填写街道、社区
       is_require_subdistrict: openStreet,
       subdistrict_parent_id,
-      subdistrict_id
+      subdistrict_id,
+      receiver_state,
+      receiver_city,
+      receiver_district
     } = orderRes
 
+    let subdistrictRes
+    if (openStreet) {
+      subdistrictRes = await getSubdistrict({
+        receiver_state,
+        receiver_city,
+        receiver_district,
+        subdistrict_parent_id,
+        subdistrict_id
+      })
+    }
+    console.log('subdistrictRes:', subdistrictRes)
+
     if (coupon_info) {
       const info = {
         type: 'coupon',
@@ -523,6 +589,23 @@ function CartCheckout(props) {
       draft.totalInfo = total_info
       draft.paramsInfo = { ...paramsInfo, ...cus_parmas }
       draft.pointInfo = point_info
+      draft.openStreet = openStreet
+      if (openStreet) {
+        const {
+          multiValue,
+          multiIndex,
+          streetCommunityList,
+          streetCommunityTxt,
+          street,
+          community
+        } = subdistrictRes
+        draft.multiValue = multiValue
+        draft.multiIndex = multiIndex
+        draft.streetCommunityList = streetCommunityList
+        draft.streetCommunityTxt = streetCommunityTxt
+        draft.street = street
+        draft.community = community
+      }
     })
     if (extraTips) {
       Taro.showModal({
@@ -626,6 +709,33 @@ function CartCheckout(props) {
     }
   }
 
+  // 街道社区
+  const bindMultiPickerChange = (e) => {
+    const [a, b] = e.detail.value
+    if (streetCommunityList[a].children == 0) {
+      return showToast('居委不能为空')
+    }
+    setState((draft) => {
+      draft.multiIndex = [a, b]
+      draft.streetCommunityTxt = `${streetCommunityList[a].label} ${streetCommunityList[a].children[b].label}`
+      draft.street = streetCommunityList[a].id
+      draft.community = streetCommunityList[a].children[b].id
+    })
+  }
+
+  // 街道社区
+  const bindMultiPickerColumnChange = (e) => {
+    const { column, value } = e.detail
+
+    if (column == 0) {
+      multiValue[1] = streetCommunityList[value].children.map((item) => item.label)
+    }
+    setState((draft) => {
+      draft.multiValue = multiValue
+      // draft.multiIndex = [value, 0]
+    })
+  }
+
   const renderFooter = () => {
     return (
       <View className='checkout-toolbar'>
diff --git a/src/pages/cart/espier-checkout.scss b/src/pages/cart/espier-checkout.scss
index 7fd8730c..a598f7af 100644
--- a/src/pages/cart/espier-checkout.scss
+++ b/src/pages/cart/espier-checkout.scss
@@ -216,4 +216,23 @@ $margin24: 24px;
       }
     }
   }
+
+  .cart-checkout__stree {
+    margin: 0 0 $margin24;
+    .sp-cell {
+      padding: 30px 16px;
+      box-shadow: 0px 2px 10px 0px #eae7e0;
+    }
+    .required {
+      color: #e62424;
+    }
+    &-desc {
+      color: #666;
+      font-size: 24px;
+    }
+    .picker-value {
+      color: #222;
+      text-align: right;
+    }
+  }
 }
-- 
2.23.0

From aeed80da934b0da7f2d40e34e0b5b88bf6819697 Mon Sep 17 00:00:00 2001
From: maqian <maqian@shopex.cn>
Date: Mon, 11 Apr 2022 16:56:51 +0800
Subject: [PATCH] ECX-1673tab

---
 src/subpage/pages/trade/after-sale.js | 16 ++++++++++------
 1 file changed, 10 insertions(+), 6 deletions(-)

diff --git a/src/subpage/pages/trade/after-sale.js b/src/subpage/pages/trade/after-sale.js
index 4c6ae9c6..0804c1c4 100644
--- a/src/subpage/pages/trade/after-sale.js
+++ b/src/subpage/pages/trade/after-sale.js
@@ -3,7 +3,7 @@ import Taro, { getCurrentInstance } from '@tarojs/taro'
 import { View, Text, ScrollView } from '@tarojs/components'
 import { AtTabs, AtTabsPane } from 'taro-ui'
 import { Loading, SpNote, SpNavBar } from '@/components'
-import { pickBy, log } from '@/utils'
+import { pickBy, log, getBrowserEnv } from '@/utils'
 import api from '@/api'
 import { connect } from 'react-redux'
 import { withLogin, withPager } from '@/hocs'
@@ -20,7 +20,7 @@ import './list.scss'
 @withLogin()
 export default class AfterSale extends Component {
   $instance = getCurrentInstance()
-  constructor (props) {
+  constructor(props) {
     super(props)
 
     this.state = {
@@ -37,7 +37,7 @@ export default class AfterSale extends Component {
     }
   }
 
-  componentDidMount () {
+  componentDidMount() {
     const { status } = this.$instance.router.params
     const tabIdx = this.state.tabList.findIndex((tab) => tab.status === status)
 
@@ -55,7 +55,7 @@ export default class AfterSale extends Component {
     }
   }
 
-  async fetch (params) {
+  async fetch(params) {
     const { tabList, curTabIdx } = this.state
 
     params = _mapKeys(
@@ -130,7 +130,7 @@ export default class AfterSale extends Component {
     })
   }
 
-  render () {
+  render() {
     const { curTabIdx, tabList, list, page } = this.state
 
     return (
@@ -147,7 +147,11 @@ export default class AfterSale extends Component {
           ))}
         </AtTabs>
 
-        <ScrollView scrollY className='trade-list__scroll' onScrollToLower={this.nextPage}>
+        <ScrollView
+          scrollY
+          className={`trade-list__scroll ${getBrowserEnv().weixin ? 'with-tabs-wx' : 'with-tabs'}`}
+          onScrollToLower={this.nextPage}
+        >
           {list &&
             list.map((item, idx) => {
               return (
-- 
2.23.0

From aeed80da934b0da7f2d40e34e0b5b88bf6819697 Mon Sep 17 00:00:00 2001
From: maqian <maqian@shopex.cn>
Date: Mon, 11 Apr 2022 16:56:51 +0800
Subject: [PATCH] ECX-1673tab

---
 src/subpage/pages/trade/after-sale.js | 16 ++++++++++------
 1 file changed, 10 insertions(+), 6 deletions(-)

diff --git a/src/subpage/pages/trade/after-sale.js b/src/subpage/pages/trade/after-sale.js
index 4c6ae9c6..0804c1c4 100644
--- a/src/subpage/pages/trade/after-sale.js
+++ b/src/subpage/pages/trade/after-sale.js
@@ -3,7 +3,7 @@ import Taro, { getCurrentInstance } from '@tarojs/taro'
 import { View, Text, ScrollView } from '@tarojs/components'
 import { AtTabs, AtTabsPane } from 'taro-ui'
 import { Loading, SpNote, SpNavBar } from '@/components'
-import { pickBy, log } from '@/utils'
+import { pickBy, log, getBrowserEnv } from '@/utils'
 import api from '@/api'
 import { connect } from 'react-redux'
 import { withLogin, withPager } from '@/hocs'
@@ -20,7 +20,7 @@ import './list.scss'
 @withLogin()
 export default class AfterSale extends Component {
   $instance = getCurrentInstance()
-  constructor (props) {
+  constructor(props) {
     super(props)
 
     this.state = {
@@ -37,7 +37,7 @@ export default class AfterSale extends Component {
     }
   }
 
-  componentDidMount () {
+  componentDidMount() {
     const { status } = this.$instance.router.params
     const tabIdx = this.state.tabList.findIndex((tab) => tab.status === status)
 
@@ -55,7 +55,7 @@ export default class AfterSale extends Component {
     }
   }
 
-  async fetch (params) {
+  async fetch(params) {
     const { tabList, curTabIdx } = this.state
 
     params = _mapKeys(
@@ -130,7 +130,7 @@ export default class AfterSale extends Component {
     })
   }
 
-  render () {
+  render() {
     const { curTabIdx, tabList, list, page } = this.state
 
     return (
@@ -147,7 +147,11 @@ export default class AfterSale extends Component {
           ))}
         </AtTabs>
 
-        <ScrollView scrollY className='trade-list__scroll' onScrollToLower={this.nextPage}>
+        <ScrollView
+          scrollY
+          className={`trade-list__scroll ${getBrowserEnv().weixin ? 'with-tabs-wx' : 'with-tabs'}`}
+          onScrollToLower={this.nextPage}
+        >
           {list &&
             list.map((item, idx) => {
               return (
-- 
2.23.0

From 4c03a7099c2323589e0064507673dedbd77017d5 Mon Sep 17 00:00:00 2001
From: lukaijie <lukaijie@shopex.cn>
Date: Mon, 11 Apr 2022 16:58:43 +0800
Subject: [PATCH] =?UTF-8?q?fix:=20=E6=B7=BB=E5=8A=A0=E7=A4=BE=E5=8C=BA?=
 =?UTF-8?q?=E8=A1=97=E9=81=93=E5=85=B3=E8=81=94=E5=9C=B0=E5=8C=BA?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 src/api/cart.js                     |   5 ++
 src/pages/cart/espier-checkout.js   | 112 +++++++++++++++++++++++++++-
 src/pages/cart/espier-checkout.scss |  19 +++++
 3 files changed, 135 insertions(+), 1 deletion(-)

diff --git a/src/api/cart.js b/src/api/cart.js
index a08c0350..959697ff 100644
--- a/src/api/cart.js
+++ b/src/api/cart.js
@@ -91,3 +91,8 @@ export function getCartRemind(params) {
 export function exchangeGood(params) {
   return req.post('user/exchangeCard', params)
 }
+
+// 获取街道、社区列表
+export function getSubdistrict(params) {
+  return req.get('/espier/subdistrict', params)
+}
diff --git a/src/pages/cart/espier-checkout.js b/src/pages/cart/espier-checkout.js
index ee787940..96823baf 100644
--- a/src/pages/cart/espier-checkout.js
+++ b/src/pages/cart/espier-checkout.js
@@ -423,6 +423,57 @@ function CartCheckout(props) {
     })
   }
 
+  // 获取街道、社区
+  const getSubdistrict = async ({
+    receiver_state,
+    receiver_city,
+    receiver_district,
+    subdistrict_parent_id,
+    subdistrict_id
+  }) => {
+    let multiValue = []
+    let multiIndex = [0, 0]
+    let streetCommunityList = []
+    let streetCommunityTxt = '请选择'
+    let street = null
+    let community = null
+
+    // 调用街道、社区接口
+    streetCommunityList = await api.cart.getSubdistrict({
+      receiver_state,
+      receiver_city,
+      receiver_district,
+      distributor_id: dtid
+    })
+    if (streetCommunityList.length > 0) {
+      multiValue[0] = streetCommunityList.map((item) => item.label)
+      multiValue[1] = streetCommunityList[0].children.map((item) => item.label)
+      streetCommunityList.forEach((pitem, pindex) => {
+        if (pitem.id == subdistrict_parent_id) {
+          pitem.children.forEach((sitem, sindex) => {
+            if (sitem.id == subdistrict_id) {
+              streetCommunityTxt = `${pitem.label} ${sitem.label}`
+              multiIndex = [pindex, sindex]
+              street = subdistrict_parent_id
+              community = subdistrict_id
+            }
+          })
+        }
+      })
+    } else {
+      showToast('暂无街道、社区配置')
+    }
+
+    return {
+      multiValue,
+      streetCommunityList,
+      multiIndex,
+      streetCommunityTxt,
+      street,
+      community
+    }
+  }
+
   const calcOrder = async () => {
     Taro.showLoading()
     const cus_parmas = await getParamsInfo()
@@ -458,9 +509,24 @@ function CartCheckout(props) {
       // 是否开启下单填写街道、社区
       is_require_subdistrict: openStreet,
       subdistrict_parent_id,
-      subdistrict_id
+      subdistrict_id,
+      receiver_state,
+      receiver_city,
+      receiver_district
     } = orderRes
 
+    let subdistrictRes
+    if (openStreet) {
+      subdistrictRes = await getSubdistrict({
+        receiver_state,
+        receiver_city,
+        receiver_district,
+        subdistrict_parent_id,
+        subdistrict_id
+      })
+    }
+    console.log('subdistrictRes:', subdistrictRes)
+
     if (coupon_info) {
       const info = {
         type: 'coupon',
@@ -523,6 +589,23 @@ function CartCheckout(props) {
       draft.totalInfo = total_info
       draft.paramsInfo = { ...paramsInfo, ...cus_parmas }
       draft.pointInfo = point_info
+      draft.openStreet = openStreet
+      if (openStreet) {
+        const {
+          multiValue,
+          multiIndex,
+          streetCommunityList,
+          streetCommunityTxt,
+          street,
+          community
+        } = subdistrictRes
+        draft.multiValue = multiValue
+        draft.multiIndex = multiIndex
+        draft.streetCommunityList = streetCommunityList
+        draft.streetCommunityTxt = streetCommunityTxt
+        draft.street = street
+        draft.community = community
+      }
     })
     if (extraTips) {
       Taro.showModal({
@@ -626,6 +709,33 @@ function CartCheckout(props) {
     }
   }
 
+  // 街道社区
+  const bindMultiPickerChange = (e) => {
+    const [a, b] = e.detail.value
+    if (streetCommunityList[a].children == 0) {
+      return showToast('居委不能为空')
+    }
+    setState((draft) => {
+      draft.multiIndex = [a, b]
+      draft.streetCommunityTxt = `${streetCommunityList[a].label} ${streetCommunityList[a].children[b].label}`
+      draft.street = streetCommunityList[a].id
+      draft.community = streetCommunityList[a].children[b].id
+    })
+  }
+
+  // 街道社区
+  const bindMultiPickerColumnChange = (e) => {
+    const { column, value } = e.detail
+
+    if (column == 0) {
+      multiValue[1] = streetCommunityList[value].children.map((item) => item.label)
+    }
+    setState((draft) => {
+      draft.multiValue = multiValue
+      // draft.multiIndex = [value, 0]
+    })
+  }
+
   const renderFooter = () => {
     return (
       <View className='checkout-toolbar'>
diff --git a/src/pages/cart/espier-checkout.scss b/src/pages/cart/espier-checkout.scss
index 7fd8730c..a598f7af 100644
--- a/src/pages/cart/espier-checkout.scss
+++ b/src/pages/cart/espier-checkout.scss
@@ -216,4 +216,23 @@ $margin24: 24px;
       }
     }
   }
+
+  .cart-checkout__stree {
+    margin: 0 0 $margin24;
+    .sp-cell {
+      padding: 30px 16px;
+      box-shadow: 0px 2px 10px 0px #eae7e0;
+    }
+    .required {
+      color: #e62424;
+    }
+    &-desc {
+      color: #666;
+      font-size: 24px;
+    }
+    .picker-value {
+      color: #222;
+      text-align: right;
+    }
+  }
 }
-- 
2.23.0

From b7577ca67dcae30c909ccd90584048c403bf305e Mon Sep 17 00:00:00 2001
From: lukaijie <lukaijie@shopex.cn>
Date: Mon, 11 Apr 2022 19:14:14 +0800
Subject: [PATCH] =?UTF-8?q?fix:=20=E8=A1=97=E9=81=93=E9=80=89=E6=8B=A9bug?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 src/components/sp-input-number/index.js | 10 +++++-----
 src/pages/cart/espier-checkout.js       | 15 +++++++++------
 2 files changed, 14 insertions(+), 11 deletions(-)

diff --git a/src/components/sp-input-number/index.js b/src/components/sp-input-number/index.js
index b033820e..34fc7db1 100644
--- a/src/components/sp-input-number/index.js
+++ b/src/components/sp-input-number/index.js
@@ -7,7 +7,7 @@ import _toString from 'lodash/toString'
 import AtComponent from './component'
 
 // 实现两数相加并保留小数点后最短尾数
-function addNum (num1, num2) {
+function addNum(num1, num2) {
   let sq1, sq2
   try {
     sq1 = _toString(num1).split('.')[1].length
@@ -24,7 +24,7 @@ function addNum (num1, num2) {
 }
 
 // 格式化数字，处理01变成1,并且不处理1. 这种情况
-function parseValue (num) {
+function parseValue(num) {
   if (num === '') return '0'
 
   const numStr = _toString(num)
@@ -36,7 +36,7 @@ function parseValue (num) {
 }
 
 class AtInputNumber extends AtComponent {
-  handleClick (clickType) {
+  handleClick(clickType) {
     const { disabled, value, min, max, step } = this.props
     const lowThanMin = clickType === 'minus' && value <= min
     const overThanMax = clickType === 'plus' && value >= max
@@ -103,7 +103,7 @@ class AtInputNumber extends AtComponent {
     this.props.onErrorInput(errorValue)
   }
 
-  render () {
+  render() {
     const { customStyle, className, width, disabled, value, type, min, max, size } = this.props
 
     const inputStyle = {
@@ -134,7 +134,7 @@ class AtInputNumber extends AtComponent {
           style={inputStyle}
           type={type}
           value={inputValue}
-          disabled
+          // disabled
           onInput={this.handleInput}
           onBlur={this.handleBlur}
         />
diff --git a/src/pages/cart/espier-checkout.js b/src/pages/cart/espier-checkout.js
index 96823baf..3f59d508 100644
--- a/src/pages/cart/espier-checkout.js
+++ b/src/pages/cart/espier-checkout.js
@@ -726,14 +726,17 @@ function CartCheckout(props) {
   // 街道社区
   const bindMultiPickerColumnChange = (e) => {
     const { column, value } = e.detail
-
+    let _multiValue = [multiValue[0]]
+    // debugger
     if (column == 0) {
-      multiValue[1] = streetCommunityList[value].children.map((item) => item.label)
+      _multiValue[1] = streetCommunityList[value].children.map((item) => item.label)
+      setState((draft) => {
+        draft.multiValue = _multiValue
+        draft.multiIndex = [value, 0]
+      })
+    } else {
     }
-    setState((draft) => {
-      draft.multiValue = multiValue
-      // draft.multiIndex = [value, 0]
-    })
+    // debugger
   }
 
   const renderFooter = () => {
-- 
2.23.0

